#!/bin/bash
#
# user-prompt-submit Hook
# Generated by Contextualizer for {{projectName}}
#
# This hook monitors context usage and provides development-specific optimizations.
#
# Warning Threshold: {{contextMonitoring.warningThreshold}}%
# Critical Threshold: {{contextMonitoring.criticalThreshold}}%
# Boundary Detection: {{contextMonitoring.boundaryDetection}}
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
WARNING_THRESHOLD={{contextMonitoring.warningThreshold}}
CRITICAL_THRESHOLD={{contextMonitoring.criticalThreshold}}
BOUNDARY_DETECTION="{{contextMonitoring.boundaryDetection}}"
PROJECT_NAME="{{projectName}}"

# Get context usage from Claude Desktop
get_context_usage() {
    # Placeholder: Return mock value for demonstration
    # In production, this would query Claude Desktop's context API
    echo "50"
}

# Provide optimization suggestions
suggest_optimizations() {
    local usage=$1

    echo ""
    echo -e "${BLUE}[OPTIMIZATION TIPS]${NC}"

    if [ "$usage" -ge 80 ]; then
        echo "  • Consider summarizing recent conversation history"
        echo "  • Archive completed features to project memory"
        echo "  • Start new conversation for next feature"
    elif [ "$usage" -ge 60 ]; then
        echo "  • Document current progress in .contextualizer/memory/"
        echo "  • Consider splitting large refactorings"
    else
        echo "  • Context usage healthy for active development"
    fi

    echo ""
}

# Main execution
main() {
    local usage
    usage=$(get_context_usage)

    echo "=== Context Monitor for $PROJECT_NAME ==="
    echo ""

    if [ "$usage" -ge "$CRITICAL_THRESHOLD" ]; then
        echo -e "${RED}[CRITICAL]${NC} Context usage at ${usage}% (threshold: ${CRITICAL_THRESHOLD}%)"
        suggest_optimizations "$usage"

        if [ "$BOUNDARY_DETECTION" = "aggressive" ]; then
            echo -e "${RED}Boundary detection: aggressive - blocking prompt${NC}"
            echo "Please optimize context before continuing"
            exit 1
        fi
    elif [ "$usage" -ge "$WARNING_THRESHOLD" ]; then
        echo -e "${YELLOW}[WARNING]${NC} Context usage at ${usage}% (threshold: ${WARNING_THRESHOLD}%)"
        suggest_optimizations "$usage"
    else
        echo -e "${GREEN}[OK]${NC} Context usage at ${usage}%"
    fi

    exit 0
}

main "$@"
