# Story 1.1: MCP Server Setup

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story

**As a** developer using Claude for AI-assisted development,
**I want** a working MCP server that Claude can communicate with via stdio,
**so that** I can invoke Contextualizer's tools, resources, and prompts through natural language.

## Acceptance Criteria

1. TypeScript 5.x project initialized with Node.js 18+ compatibility
2. @modelcontextprotocol/sdk integrated and configured
3. Stdio transport implemented and functional
4. tsup configured for fast TypeScript bundling
5. Project structure follows MCP server architecture standards
6. Server successfully starts and accepts MCP protocol messages
7. Basic tool/resource/prompt registration infrastructure in place
8. Server responds to initialize handshake from Claude
9. Graceful shutdown on SIGINT/SIGTERM signals
10. Logging infrastructure outputs to `.contextualizer/mcp.log`

## Tasks / Subtasks

- [ ] **Task 1: Initialize TypeScript Project** (AC: 1, 4, 5)
  - [ ] Create `package.json` with Node.js 18+ requirement
  - [ ] Install TypeScript 5.x and configure `tsconfig.json`
  - [ ] Configure tsup for ESM bundling with sourcemaps
  - [ ] Set up npm scripts: `build`, `dev`, `start`
  - [ ] Create initial directory structure per architecture spec
  - [ ] Add `.gitignore` for `dist/`, `node_modules/`, `.contextualizer/`

- [ ] **Task 2: Integrate MCP SDK** (AC: 2, 3, 8)
  - [ ] Install `@modelcontextprotocol/sdk` package
  - [ ] Create `src/server.ts` with Server initialization
  - [ ] Configure server metadata (name: "contextualizer", version: "1.0.0")
  - [ ] Configure capabilities (tools, resources, prompts)
  - [ ] Implement StdioServerTransport connection
  - [ ] Add MCP protocol handshake handling

- [ ] **Task 3: Implement Server Lifecycle** (AC: 6, 9)
  - [ ] Create main() async function with error handling
  - [ ] Implement server startup sequence
  - [ ] Add SIGINT signal handler for graceful shutdown
  - [ ] Add SIGTERM signal handler for graceful shutdown
  - [ ] Implement server.close() on shutdown
  - [ ] Add process.exit() with appropriate exit codes

- [ ] **Task 4: Set Up Logging Infrastructure** (AC: 10)
  - [ ] Install `pino` logging library
  - [ ] Create `src/utils/logger.ts` wrapper
  - [ ] Configure log level from environment (default: 'info')
  - [ ] Configure log destination: `.contextualizer/mcp.log`
  - [ ] Add structured logging fields (timestamp, level, message, context)
  - [ ] Add log rotation configuration (10MB, 5 files)

- [ ] **Task 5: Create Tool/Resource/Prompt Infrastructure** (AC: 7)
  - [ ] Create `src/tools/index.ts` with TOOLS array export
  - [ ] Create `src/resources/index.ts` with RESOURCES array export
  - [ ] Create `src/prompts/index.ts` with PROMPTS array export
  - [ ] Add ListToolsRequestSchema handler (returns empty array initially)
  - [ ] Add ListResourcesRequestSchema handler (returns empty array initially)
  - [ ] Add ListPromptsRequestSchema handler (returns empty array initially)
  - [ ] Add CallToolRequestSchema handler skeleton
  - [ ] Add ReadResourceRequestSchema handler skeleton
  - [ ] Add GetPromptRequestSchema handler skeleton

- [ ] **Task 6: Create Type Definitions** (AC: 5)
  - [ ] Create `src/types/mcp.ts` with MCPTool interface
  - [ ] Create `src/types/mcp.ts` with MCPResource interface
  - [ ] Create `src/types/mcp.ts` with MCPPrompt interface
  - [ ] Create `src/types/mcp.ts` with ToolResult interface
  - [ ] Create `src/types/mcp.ts` with ResourceContent interface
  - [ ] Create `src/types/mcp.ts` with PromptMessage interface

- [ ] **Task 7: Unit Testing** (AC: All)
  - [ ] Install `vitest` and configure `vitest.config.ts`
  - [ ] Create `tests/unit/server.test.ts`
  - [ ] Test: Server initialization with correct metadata
  - [ ] Test: Server capabilities configuration
  - [ ] Test: Graceful shutdown handling
  - [ ] Test: Logger initialization
  - [ ] Create `tests/unit/logger.test.ts`
  - [ ] Test: Log levels (error, warn, info, debug)
  - [ ] Test: Log file creation and writing

- [ ] **Task 8: Integration Testing** (AC: 6, 8)
  - [ ] Create `tests/integration/mcp-protocol.test.ts`
  - [ ] Test: Complete MCP handshake (initialize → initialized)
  - [ ] Test: tools/list returns empty array
  - [ ] Test: resources/list returns empty array
  - [ ] Test: prompts/list returns empty array
  - [ ] Test: Server responds to invalid requests with errors
  - [ ] Test: Server handles stdio transport communication

## Dev Notes

### Previous Story Insights
- This is the first story in the project - no previous story context

### Architecture Overview

**Source Context**: This story implements the foundation described in:
- [Source: architecture/mcp-server.md#overview]
- [Source: architecture/mcp-server.md#mcp-protocol-interface]
- [Source: architecture/mcp-server.md#server-lifecycle]

### Technology Stack

[Source: architecture/mcp-server.md#technology-stack]

| Component | Technology | Version | Rationale |
|-----------|-----------|---------|-----------|
| **Runtime** | Node.js | 18+ | LTS, MCP SDK compatibility, wide ecosystem |
| **Language** | TypeScript | 5.x | Type safety, developer experience, tooling |
| **MCP SDK** | @modelcontextprotocol/sdk | latest | Official Anthropic SDK, protocol compliance |
| **Transport** | stdio | built-in | Standard for Claude integration, simple, reliable |
| **Bundler** | tsup | latest | Fast, zero-config TypeScript bundler |
| **Logging** | pino | latest | Fast, structured, low overhead |
| **Testing** | vitest | latest | Fast, ESM-native, compatible with modern TypeScript |

### Project Structure

[Source: architecture/integration-data.md#file-system-layout]

Create the following directory structure:

```
contextualizer/
├── src/
│   ├── server.ts           # Main server entry point
│   ├── types/
│   │   └── mcp.ts          # MCP interface definitions
│   ├── tools/
│   │   └── index.ts        # Tool registry (empty initially)
│   ├── resources/
│   │   └── index.ts        # Resource registry (empty initially)
│   ├── prompts/
│   │   └── index.ts        # Prompt registry (empty initially)
│   └── utils/
│       └── logger.ts       # Pino logger wrapper
├── tests/
│   ├── unit/
│   │   ├── server.test.ts
│   │   └── logger.test.ts
│   └── integration/
│       └── mcp-protocol.test.ts
├── dist/                   # Build output (gitignored)
├── package.json
├── tsconfig.json
├── tsup.config.ts
└── vitest.config.ts
```

### MCP Protocol Interface

[Source: architecture/mcp-server.md#mcp-protocol-interface]

**Communication Pattern**:
- Request-Response over stdio
- JSON-RPC 2.0 format
- Claude sends requests to stdin
- Server responds via stdout

**Message Types to Support**:
1. `initialize`: Handshake and capabilities exchange
2. `tools/list`: Claude discovers available tools
3. `tools/call`: Execute tool with parameters
4. `resources/list`: Claude discovers available resources
5. `resources/read`: Fetch resource content
6. `prompts/list`: Claude discovers available prompts
7. `prompts/get`: Fetch prompt template

### Server Implementation Pattern

[Source: architecture/mcp-server.md#server-lifecycle]

```typescript
// src/server.ts - Skeleton structure
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { TOOLS } from './tools/index.js';
import { RESOURCES } from './resources/index.js';
import { PROMPTS } from './prompts/index.js';
import { logger } from './utils/logger.js';

async function main() {
  // 1. Initialize server with metadata and capabilities
  const server = new Server(
    {
      name: "contextualizer",
      version: "1.0.0",
    },
    {
      capabilities: {
        tools: {},
        resources: {},
        prompts: {},
      },
    }
  );

  // 2. Register handlers (initially return empty arrays)
  server.setRequestHandler(ListToolsRequestSchema, async () => ({
    tools: TOOLS.map(t => ({
      name: t.name,
      description: t.description,
      inputSchema: t.inputSchema
    })),
  }));

  // ... similar for resources and prompts

  // 3. Start stdio transport
  const transport = new StdioServerTransport();
  await server.connect(transport);

  logger.info('Contextualizer MCP Server started');

  // 4. Graceful shutdown
  process.on('SIGINT', async () => {
    logger.info('Shutting down...');
    await server.close();
    process.exit(0);
  });
}

main().catch((error) => {
  logger.error({ error }, 'Fatal error');
  process.exit(1);
});
```

### Type Definitions

[Source: architecture/mcp-server.md#tool-system-interface]

```typescript
// src/types/mcp.ts
import { JSONSchema } from '@modelcontextprotocol/sdk/types.js';

export interface MCPTool {
  name: string;
  description: string;
  inputSchema: JSONSchema;
  handler: (params: unknown) => Promise<ToolResult>;
}

export interface ToolResult {
  content: Array<{
    type: "text" | "image" | "resource";
    text?: string;
    data?: string;
    mimeType?: string;
  }>;
  isError?: boolean;
}

export interface MCPResource {
  uri: string;
  name: string;
  description: string;
  mimeType: string;
  provider: () => Promise<ResourceContent>;
}

export interface ResourceContent {
  uri: string;
  mimeType: string;
  text?: string;
  blob?: string;
}

export interface MCPPrompt {
  name: string;
  description: string;
  arguments?: Array<{
    name: string;
    description: string;
    required?: boolean;
  }>;
  provider: (args: Record<string, string>) => Promise<PromptMessage[]>;
}

export interface PromptMessage {
  role: "user" | "assistant";
  content: {
    type: "text" | "image" | "resource";
    text?: string;
  };
}
```

### Logging Configuration

[Source: architecture/mcp-server.md#server-lifecycle]
[Source: architecture/security-performance-testing.md#performance-targets]

**Requirements**:
- Structured JSON logging with pino
- Log destination: `.contextualizer/mcp.log`
- Log levels: error, warn, info, debug
- Include context: tool names, parameters (sanitized), timing
- Low overhead (< 5ms per log statement)

```typescript
// src/utils/logger.ts
import pino from 'pino';
import { mkdirSync } from 'fs';
import { dirname } from 'path';

const logPath = '.contextualizer/mcp.log';
mkdirSync(dirname(logPath), { recursive: true });

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino/file',
    options: { destination: logPath }
  },
  formatters: {
    level: (label) => ({ level: label }),
  },
});
```

### Build Configuration

**tsconfig.json**:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "lib": ["ES2022"],
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**tsup.config.ts**:
```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/server.ts'],
  format: ['esm'],
  target: 'node18',
  sourcemap: true,
  clean: true,
  dts: true,
});
```

**package.json scripts**:
```json
{
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch",
    "start": "node dist/server.js",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage"
  }
}
```

### Performance Targets

[Source: architecture/security-performance-testing.md#performance-targets]

- **Server startup**: < 500ms
- **MCP handshake**: < 200ms
- **Logging overhead**: < 5ms per statement

### Security Considerations

[Source: architecture/security-performance-testing.md#security-model]

- All stdio input/output is handled by MCP SDK (no direct parsing)
- No network access from server (stdio only)
- Error messages sanitized (no sensitive data leakage)
- Process isolation (runs in separate Node.js process)

### Testing

#### Testing Standards

[Source: architecture/security-performance-testing.md#testing-architecture]

**Test Framework**: Vitest (fast, ESM-native, TypeScript support)

**Test Structure**:
- Unit tests: Individual function/class testing
- Integration tests: Multi-component workflows
- Target coverage: 80%+ lines, functions, branches

**vitest.config.ts**:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['tests/**', 'dist/**', '**/*.test.ts', '**/*.config.ts'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 75,
        statements: 80,
      },
    },
  },
});
```

**Test File Locations**:
- Unit tests: `tests/unit/*.test.ts`
- Integration tests: `tests/integration/*.test.ts`
- Follow naming: `{component}.test.ts`

#### Unit Test Requirements

[Source: architecture/security-performance-testing.md#unit-test-strategy]

1. **Server Initialization Tests** (`tests/unit/server.test.ts`):
   - Test server metadata (name, version)
   - Test capabilities configuration
   - Test handler registration
   - Test graceful shutdown

2. **Logger Tests** (`tests/unit/logger.test.ts`):
   - Test log levels (error, warn, info, debug)
   - Test log file creation
   - Test structured logging format

#### Integration Test Requirements

[Source: architecture/security-performance-testing.md#integration-test-strategy]

1. **MCP Protocol Tests** (`tests/integration/mcp-protocol.test.ts`):
   - Test complete handshake (initialize → initialized)
   - Test tools/list endpoint
   - Test resources/list endpoint
   - Test prompts/list endpoint
   - Test error responses for invalid requests

**Example Integration Test Pattern**:
```typescript
import { describe, it, expect } from 'vitest';
import { spawn } from 'child_process';

describe('MCP Protocol Integration', () => {
  it('completes initialize handshake', async () => {
    const server = spawn('node', ['dist/server.js']);

    // Send initialize request
    server.stdin.write(JSON.stringify({
      jsonrpc: '2.0',
      method: 'initialize',
      params: { protocolVersion: '1.0.0', capabilities: {} },
      id: 1,
    }) + '\n');

    // Wait for response
    const response = await new Promise<any>((resolve) => {
      server.stdout.once('data', (data) => {
        resolve(JSON.parse(data.toString()));
      });
    });

    expect(response.result.protocolVersion).toBe('1.0.0');
    expect(response.result.capabilities).toHaveProperty('tools');

    server.kill();
  });
});
```

### Dependencies to Install

```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "latest",
    "pino": "^8.0.0"
  },
  "devDependencies": {
    "@types/node": "^18.0.0",
    "typescript": "^5.0.0",
    "tsup": "^8.0.0",
    "vitest": "^1.0.0",
    "@vitest/coverage-v8": "^1.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### Implementation Notes

1. **Keep it minimal**: This story only sets up the server skeleton. No actual tools, resources, or prompts are implemented yet - those come in Story 1.2+
2. **ESM modules**: Use `.js` extensions in imports even for `.ts` files (TypeScript + ESM requirement)
3. **Empty registries**: Tool/resource/prompt arrays should be empty but the infrastructure should be in place
4. **Error handling**: Main function should catch and log all errors, exiting with code 1 on failure
5. **Stdio transport**: StdioServerTransport handles all stdin/stdout communication - don't add manual console.log statements

### Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Unit tests passing with 80%+ coverage
- [ ] Integration tests passing
- [ ] Build completes without errors (`npm run build`)
- [ ] Server starts and responds to MCP initialize handshake
- [ ] Logs written to `.contextualizer/mcp.log`
- [ ] Code follows TypeScript best practices
- [ ] No lint errors
- [ ] Documentation comments added to public APIs

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
